!function(root,factory){"use strict";"function"==typeof define&&define.amd?define([],factory):root.Cache=factory()}(this,function(){"use strict";var Cache=function(size,lifetime){var _size="number"==typeof size&&size>1?size:5,_lifetime="number"==typeof lifetime&&lifetime>0?1e3*lifetime:0,_callbacks={};_callbacks["cache:read"]=[],_callbacks["cache:write"]=[],_callbacks["cache:write:create"]=[],_callbacks["cache:write:update"]=[],_callbacks["cache:remove"]=[],_callbacks["cache:purge"]=[],_callbacks["cache:garbage"]=[],this.getSize=function(){return _size},this.setSize=function(size){return _size=size,this},this.getLifetime=function(){return _lifetime},this.setLifetime=function(lifetime){return _lifetime=1e3*lifetime,this},this.convertLifetime=function(lifetime){return"number"==typeof lifetime?1e3*lifetime:this.getLifetime()},this.scheduleStorageGarbage=function(key,value,lifetime){var self=this,timeoutID=void 0;return lifetime>0&&(timeoutID=setTimeout(function(){self.remove(key),self.trigger("cache:garbage",key,value)},lifetime)),timeoutID},this.cancelStorageGarbage=function(timeoutID){"number"==typeof timeoutID&&window.clearTimeout(timeoutID)},this.trigger=function(eventName,key,data){if(eventName in _callbacks)for(var i=0;i<_callbacks[eventName].length;i++)!function(fn,context){"function"==typeof fn&&setTimeout(function(fn,context,key,data){fn.call(context,key,data)},0,fn,context,key,data)}(_callbacks[eventName][i][0],_callbacks[eventName][i][1])},this.on=function(eventName,fn,context){return eventName in _callbacks&&_callbacks[eventName].push([fn,context]),this},this.off=function(eventName,fn){if(eventName in _callbacks)if(fn)for(var i=0;i<_callbacks[eventName].length;i++)_callbacks[eventName][i][0]===fn&&delete _callbacks[eventName][i];else _callbacks[eventName]=[];return this},this.onRead=function(fn,context){return this.on("cache:read",fn,context||this),this},this.offRead=function(fn){return this.off("cache:read",fn),this},this.onWrite=function(fn,context){return this.on("cache:write",fn,context||this),this},this.offWrite=function(fn){return this.off("cache:write",fn),this},this.onRemove=function(fn,context){return this.on("cache:remove",fn,context||this),this},this.offRemove=function(fn){return this.off("cache:remove",fn),this},this.onGarbage=function(fn,context){return this.on("cache:garbage",fn,context||this),this},this.offGarbage=function(fn){return this.off("cache:garbage",fn),this},this.count=function(){},this.has=function(key){},this.hasValue=function(value){},this.read=function(key,defaultValue,options){},this.readAll=function(){},this.write=function(key,value,lifetime,options){},this.remove=function(key,options){},this.purge=function(options){},this.setCacheLifetime=function(key,lifetime){}},MemoryCache=function(size,lifetime){Cache.call(this,size,lifetime);var _storage=[];this.count=function(){return _storage.length},this.has=function(key){for(var i=0;i<_storage.length;i++)if(_storage[i].key===key)return!0;return!1},this.hasValue=function(value){for(var i=0;i<_storage.length;i++)if(_storage[i].value===value)return!0;return!1},this.read=function(key,defaultValue,options){options||(options={});for(var i=0;i<_storage.length;i++)if(_storage[i].key===key)return void 0!==options.silent&&0!=options.silent||this.trigger("cache:read",key,_storage[i].value),_storage[i].value;return void 0===defaultValue?null:defaultValue},this.readAll=function(){for(var attributes={},i=0;i<_storage.length;i++)attributes[_storage[i].key]=_storage[i].value;return attributes},this.write=function(key,value,lifetime,options){options||(options={});for(var i=0;i<_storage.length;i++)if(_storage[i].key===key)return this.cancelStorageGarbage(_storage[i].timeoutID),"number"==typeof lifetime&&(_storage[i].lifetime=this.convertLifetime(lifetime)),_storage[i].value=value,_storage[i].timeoutID=this.scheduleStorageGarbage(key,value,_storage[i].lifetime),void 0!==options.silent&&0!=options.silent||(this.trigger("cache:write",key,value),this.trigger("cache:write:update",key,value)),this;for(lifetime=this.convertLifetime(lifetime);_storage.length>=this.getSize();)_storage.pop();return _storage.unshift({key:key,value:value,lifetime:lifetime,timeoutID:this.scheduleStorageGarbage(key,value,lifetime)}),void 0!==options.silent&&0!=options.silent||(this.trigger("cache:write",key,value),this.trigger("cache:write:create",key,value)),this},this.remove=function(key,options){options||(options={});for(var i=0;i<_storage.length;i++)if(_storage[i].key===key){var value=_storage[i].value;delete _storage[i],void 0!==options.silent&&0!=options.silent||this.trigger("cache:remove",key,value)}return this},this.purge=function(options){return _storage=[],options||(options={}),void 0!==options.silent&&0!=options.silent||this.trigger("cache:purge"),this},this.setCacheLifetime=function(key,lifetime){lifetime=this.convertLifetime(lifetime);for(var i=0;i<_storage.length;i++)if(_storage[i].key===key){this.cancelStorageGarbage(_storage[i].timeoutID),_storage[i].lifetime=lifetime,_storage[i].timeoutID=this.scheduleStorageGarbage(key,_storage[i].value,lifetime);break}return this}},StorageCache=function(size,lifetime,_storage){Cache.call(this,size,lifetime),this.initialize=function(){for(var self=this,currentTime=(new Date).getTime(),i=0;i<_storage.length;i++)!function(key){var item=JSON.parse(_storage.getItem(key));item.lifetime>0&&(currentTime>=item.createdAt+item.lifetime?_storage.removeItem(key):(item.createdAt=currentTime,item.timeoutID=self.scheduleStorageGarbage(key,item.value,item.lifetime-(currentTime-item.createdAt)),_storage.setItem(key,JSON.stringify(item))))}(_storage.key(i))},3==arguments.length&&this.initialize(),this.count=function(){return _storage.length},this.has=function(key){for(var i=0;i<_storage.length;i++)if(function(itemKey){return key===itemKey}(_storage.key(i)))return!0;return!1},this.hasValue=function(value){for(var i=0;i<_storage.length;i++)if(function(key){return value===JSON.parse(_storage.getItem(key)).value}(_storage.key(i)))return!0;return!1},this.read=function(key,defaultValue,options){options||(options={});var item=_storage.getItem(key);return item?(item=JSON.parse(item),void 0!==options.silent&&0!=options.silent||this.trigger("cache:read",key,item.value),item.value):void 0===defaultValue?null:defaultValue},this.readAll=function(){for(var attributes={},i=0;i<_storage.length;i++)!function(key){attributes[key]=JSON.parse(_storage.getItem(key)).value}(_storage.key(i));return attributes},this.write=function(key,value,lifetime,options){var self=this;options||(options={});for(var i=0;i<_storage.length;i++)if(!0===function(itemKey){if(key===itemKey){var item=JSON.parse(_storage.getItem(key));return self.cancelStorageGarbage(item.timeoutID),"number"==typeof lifetime&&(item.lifetime=self.convertLifetime(lifetime)),item.value=value,item.createdAt=(new Date).getTime(),item.timeoutID=self.scheduleStorageGarbage(key,value,item.lifetime),_storage.setItem(key,JSON.stringify(item)),void 0!==options.silent&&0!=options.silent||(self.trigger("cache:write",key,value),self.trigger("cache:write:update",key,value)),!0}return!1}(_storage.key(i)))return this;for(lifetime=this.convertLifetime(lifetime);_storage.length>=this.getSize();)_storage.removeItem(_storage.key(_storage.length-1));return _storage.setItem(key,JSON.stringify({value:value,lifetime:lifetime,createdAt:(new Date).getTime(),timeoutID:self.scheduleStorageGarbage(key,value,lifetime)})),void 0!==options.silent&&0!=options.silent||(this.trigger("cache:write",key,value),this.trigger("cache:write:create",key,value)),this},this.remove=function(key,options){options||(options={});var value=this.read(key,void 0,!0);return value&&(_storage.removeItem(key),void 0!==options.silent&&0!=options.silent||this.trigger("cache:remove",key,value)),this},this.purge=function(options){return options||(options={}),_storage.clear(),void 0!==options.silent&&0!=options.silent||this.trigger("cache:purge"),this},this.setCacheLifetime=function(key,lifetime){lifetime=this.convertLifetime(lifetime);for(var i=0;i<_storage.length&&!0!==function(self,itemKey){if(key===itemKey){var item=JSON.parse(_storage.getItem(key));return self.cancelStorageGarbage(item.timeoutID),item.lifetime=lifetime,item.createdAt=(new Date).getTime(),item.timeoutID=self.scheduleStorageGarbage(key,item.value,lifetime),_storage.setItem(key,JSON.stringify(item)),!0}return!1}(this,_storage.key(i));i++);return this}},SessionStorageCache=function(size,lifetime){StorageCache.call(this,size,lifetime,window.sessionStorage)},LocalStorageCache=function(size,lifetime){StorageCache.call(this,size,lifetime,window.localStorage)};return MemoryCache.prototype=new Cache,SessionStorageCache.prototype=new StorageCache,LocalStorageCache.prototype=new StorageCache,{Memory:MemoryCache,SessionStorage:SessionStorageCache,LocalStorage:LocalStorageCache}});